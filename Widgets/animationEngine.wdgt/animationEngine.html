<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
      #myCanvas {
        border: 1px solid #9C9898;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="1024" height="768"></canvas>
    <!-- <canvas id="myCanvas2" width="578" height="400"></canvas> -->

    <script>
      window.requestAnimFrame =   window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              window.oRequestAnimationFrame      || 
              window.msRequestAnimationFrame     || 
              function(/* function */ callback, /* DOMElement */ element){
                window.setTimeout(callback, 16);
              };

      var animNumber = 1;
      var touchAnimFrameNumber = 1;

      function loadImages() {

        skyImage = new Image();
        skyImage.src = "res/textures/sky.png";
        skyImage.speed = 1;
        skyImage.offsetX = 0;

        earthFarImage = new Image();
        earthFarImage.src = "res/textures/earth-far.png";
        earthFarImage.speed = 3;
        earthFarImage.offsetX = 0;

        earthNearImage = new Image();
        earthNearImage.src = "res/textures/earth-near.png";
        earthNearImage.speed = 6;
        earthNearImage.offsetX = 0;

        imageArray = new Array(29);
        for (var i = 1; i <= 29; i++) {
          var tempImage = new Image();
          if (i < 10) {tempImage.src = "res/anim/idle/idle000"+i+".png";}
          else if (i < 100) {tempImage.src = "res/anim/idle/idle00"+i+".png";}
          imageArray[i-1] = tempImage;
        };

        touchAnimationArray = new Array(45);
        for (var i = 1; i <= 45; i++) {
          var tempImage = new Image();
          if (i < 10) {tempImage.src = "res/anim/touch/01_touch000"+i+".png";}
          else if (i < 100) {tempImage.src = "res/anim/touch/01_touch00"+i+".png";}
          touchAnimationArray[i-1] = tempImage;
        };
      }

      var rotationAngle1 = 0;

      var lastCalledTime;
      var fps;
      var fpsCounter = 0;
      var fpsDeltaTime;

      function animate() {

        fpsCounter++; 
        fpsDeltaTime += (new Date().getTime() - lastCalledTime)/1000;
        lastCalledTime = new Date().getTime();
        if (fpsCounter == 100)
        {
          console.log("fps = " + fpsCounter/fpsDeltaTime);
          fpsCounter = 0;
          fpsDeltaTime = 0;
        }


        // if(!lastCalledTime) {
        //    lastCalledTime = new Date().getTime();
        //    fps = 0;
        // } 
        // else 
        // {
        //   delta = (new Date().getTime() - lastCalledTime)/1000;
        //   lastCalledTime = new Date().getTime();
        //   fps = 1/delta;
        // }
        // console.log("fps = " + fps);

        var canvas = document.getElementById("myCanvas");
        var context = canvas.getContext("2d");

        // update stage
        skyImage.offsetX += skyImage.speed;
        if (skyImage.offsetX > canvas.width) {skyImage.offsetX -= canvas.width};

        earthFarImage.offsetX += earthFarImage.speed;
        if (earthFarImage.offsetX > canvas.width) {earthFarImage.offsetX -= canvas.width};

        earthNearImage.offsetX += earthNearImage.speed;
        if (earthNearImage.offsetX > canvas.width) {earthNearImage.offsetX -= canvas.width};

        animNumber++;
        if (animNumber > 29) {animNumber = 1};
        touchAnimFrameNumber++;
        if (touchAnimFrameNumber > 45) {touchAnimFrameNumber = 1};

        rotationAngle1 += Math.PI / 200.0;

        // clear stage
        context.clearRect(0, 0, canvas.width, canvas.height);

        // render stage

        // draw sky
        context.drawImage(skyImage, skyImage.offsetX, 0);
        context.drawImage(skyImage, skyImage.offsetX - canvas.width, 0);

        // draw earth
        context.drawImage(earthFarImage, earthFarImage.offsetX, 0);
        context.drawImage(earthFarImage, earthFarImage.offsetX - canvas.width, 0);
        
        context.drawImage(earthNearImage, earthNearImage.offsetX, 0);
        context.drawImage(earthNearImage, earthNearImage.offsetX - canvas.width, 0);

        // image1
        context.save();
        // context.translate(canvas.width / 2, canvas.height / 2);
        // context.rotate(rotationAngle1);
        // context.translate(200, 0);

        context.transform(Math.cos(rotationAngle1), Math.sin(rotationAngle1), -Math.sin(rotationAngle1), Math.cos(rotationAngle1), canvas.width / 2 + 200, canvas.height / 2);

        context.scale(1, 3);

        context.drawImage(imageArray[animNumber-1], -imageArray[animNumber-1].width/2, -imageArray[animNumber-1].height/2);
        context.restore();

        // image2
        context.drawImage(touchAnimationArray[touchAnimFrameNumber-1], 0, 0);

        // request new frame
        requestAnimFrame(function() {
          animate();
        });

      }

      var skyImage;
      var earthFarImage;
      var earthNearImage;
      var imageArray;
      var touchAnimationArray;

      window.onload = function() {
        loadImages();
        animate();
      };
    </script>
  </body>
</html>